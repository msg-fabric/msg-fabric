require('source-map-support').install()
import Hub from '../dist/msg-fabric-node'

async function main_demo() ::
  try ::
    var hub_port = 18000
    var id_hub = await main_server()

    await main_client_one @ id_hub
    await main_client_two @ id_hub
    return true
  catch err ::
    console.error(err)
    return false



  async function main_server() ::
    const hub = new Hub()
    const svr = hub.tcp.createServer()
      .listen(hub_port, '127.0.0.1')

    setTimeout @
      () => ::
        console.log @ 'Allowing server to expireâ€¦'
        svr.unref()
      200

    hub.router.registerTarget @ 123, (msg, router) => ::
      const header = msg.header_json()
      const body = msg.body_json()
      console.log @ 'target got message!', @: header, body

    return hub.router.id_self

  async function main_client_one(id_hub) ::
    const hub = new Hub()
    const channel = await hub.tcp.connect @: host:'127.0.0.1', port: hub_port
    channel.sendJSON @:
      id_router: id_hub
      id_target: 123
      header: @: bonkers: true

  async function main_client_two(id_hub) ::
    const hub = new Hub()
    const channel = await hub.connect(`tcp://127.0.0.1:${hub_port}`)
    channel.sendJSON @:
      id_router: id_hub
      id_target: 123
      body: @: hello: 'there'


if module === require.main ::
  main_demo()

  process.on @ 'unhandledRejection', (reason, p) => ::
    console.log @ 'Unhandled Rejection at:', p, 'reason:', reason
